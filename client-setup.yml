---
- name: Ansible create client Infra playbook
  hosts: [hypervisors]
  user: root
  vars_files:
    - vars/setup.yml
    
  tasks:
    - name: install packages
      apt:
        name: "{{ packages }}"
        state: present

    - name: Create management namespace
      namespace:
        name: "{{cid}}_mns"
        state: present

    - name: Create network
      shell: scripts/create_net.sh {{cid}}mnw_{{item.id}} {{cid}}mbr_{{item.id}}
      become: yes
      loop: "{{mgmt_conns}}"

    - name: Create veth link
      shell: scripts/create_veth_ns_br.sh {{cid}}_mns {{item.ip}} {{cid}}mbr_{{item.id}} {{cid}}mve1_{{item.id}} {{cid}}mve2_{{item.id}}
      become: yes
      loop: "{{mgmt_conns}}"

    - name: Create DHCP server for the bridge
      command: "ip netns exec dhcptest dnsmasq --interface={{cid}}mve1_{{item.id}} --dhcp-range={{ item.range }},12h --bind-interfaces --except-interface=lo"
      ignore_errors: true
      become: yes
      loop: "{{ mgmt_conns }}"

    # - name: Create veth pair {{network_id}}
    #   command: "ip link add {{cid}}mve1_{{item}} type veth peer name {{cid}}mve2_{{item}}"
    #   become: yes
    #   loop: ['s','t']
    #   ignore_errors: yes

    # - name: Link veth to namespace
    #   command: "ip link set {{cid}}mve1_{{item}} netns {{cid}}_mns"
    #   become: yes
    #   loop: ['s','t']
    #   ignore_errors: yes

    # - name: Link veth to bridge
    #   command: "brctl addif {{cid}}mbr_{{item}} {{cid}}mve1_{{item}}"
    #   become: yes
    #   loop: ['s','t']
    #   ignore_errors: yes